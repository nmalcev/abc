<!DOCTYPE html>
<html>
<head>
	<title>PreEdit</title>
	<meta charset="utf-8"/>
<style>
body{
	margin: 0;
	font: 13px/15px Arial;
	color: #333;
}
.edit{
	display: inline-block;
	outline: none;
	margin: 0;
	min-height: 100%;
	min-width: 100%;
	font-family: Arial;
}
.wrap{
	
	width: 100%;
	height: 200px;
	overflow: auto;
}
.scale{
	text-align: right;
	padding: 0 3px;
	background: #eee;
	color: #666;
	font-size: 11px;
}

/*	NEW	*/
.container{
	border: 1px solid #aaa;
	width: 800px;
	margin: 20px;
	height: 500px;

}
.scale-wrap{
	-webkit-flex: 0 0 auto;
	-moz-flex: 0 0 auto;
	flex: 0 0 auto;
	height: 100%;
	overflow: hidden;

}
.edit-wrap{
	-webkit-flex: 1 0 0;
	-moz-flex: 1 0 0;
	flex: 1 0 0;
}


/*.sc_edit-pre{
	position: absolute;
	left: 1px;
	top: 28px;
	right: 1px;
	bottom: 1px;
	margin: 0;
	overflow-x: auto;
	overflow-y: scroll;
	padding: 0 0 0 40px;

	font-family: Open Sans, Menlo, Monaco, Courier New, monospace, serif;
	tab-size: 4; 
	counter-reset: list 0;
	z-index: 2;
}
.sc_edit-pre:focus{
	outline: 1px solid #999;
}
*/

.sourcebox{
	white-space: pre;
}

</style>
	<link rel="stylesheet" type="text/css" href="../css/syntax_h.css"/>
</head>
<body>
	<div class="container" id="js-form"></div>
	<div class="container sourcebox" id="js-form-alt"></div>
	<div class="container sourcebox" id="js-form-str"></div>
<script src="../lib/preedit.js"></script>
<script src="../lib/$4_clean.js"></script>
<script src="../lib/backside.js"></script>
<script src="../js/highlights.js"></script>
<script src="../js/edit.view.js"></script>
<script>

function node(tag, className, text){
	var n = document.createElement(tag);
	n.className = className;
	n.textContent = text;
	return n;
}


function JsHighlight2(){}
JsHighlight2.prototype = {
	PRETTIFY: new RegExp(
		"(//.*(?=[\\n]|$))|" + // single line comment
		'(\\/\\*[\\s\\S]*?($|\\*\\/))|' + // multiline comment
		'((?:\"[^\"\\\\]*(?:\\\\.[^\"\\\\]*)*\")|(?:\'[^\'\\\\]*(?:\\\\.[^\'\\\\]*)*\'))|' + // single or double quote strings
		'(`[\\s\\S]+?`)|' + // multiline js strings
		'(' + // regular expression literal 
			'(?:\\/[^\\s]+(?!\\\\)\\/)[img]{0,3}(?!\\d)(?=\\s*[\\;,\\x5d\\x29\\x2e\\n]?)' +
		')|' +		
		"(\\b(?:break|continue|do|else|for|if|return|while|var|function|new)\\b)|" + // keywords
		"(\\b(?:(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?)|(?:undefined|null)\\b)|" + // numbers
		"(?:[.]([\\w]+)(?=[(]))", // methods
	'g'),
	prettify: function(str){
		var 	$f = document.createDocumentFragment(),
				offset = 0;

		// var source = str;

		// Escape unicode characters
		var source = str.replace(/([\u0080-\u0400\u04FF-\uFFFF])/g, function(s){
			var 	c = s.charCodeAt(0).toString(16), 
					i = 4 - c.length; 

			while(i-- > 0) c = '0' + c; 
			return '\\u' + c;
		});


		var out = source.replace(this.PRETTIFY, function(subStr, p1, p2, p2end, str1, str2, reg, p5, p6, p7, pos, match){
			$f.appendChild(document.createTextNode(source.substring(offset, pos)));

			if(p1 != undefined){
				$f.appendChild(node('span', 'sh_js_comment', subStr));
			}else if(p2 != undefined){
				var 	lines = subStr.split(/\n/g);
				for(var i = 0; i < lines.length; i++){
					i > 0 && $f.appendChild(document.createTextNode('\n'));
					$f.appendChild(node('span', 'sh_js_comment sh_multiline', lines[i]));					
				}
			}else if(str1 != undefined || reg != undefined){	
				$f.appendChild(node('span', 'sh_js_string', subStr));
			}else if(str2 != undefined){
				var 	lines = subStr.split(/\n/g);
				for(var i = 0; i < lines.length; i++){
					i > 0 && $f.appendChild(document.createTextNode('\n'));
					$f.appendChild(node('span', 'sh_js_string sh_multiline', lines[i]));					
				}
			}else if(p5 != undefined){
				$f.appendChild(node('span', 'sh_js_keyword', subStr));
			}else if(p6 != undefined){
				$f.appendChild(node('span', 'sh_js_number', subStr));
			}else if(p7 != undefined){
				$f.appendChild(document.createTextNode('.'));
				$f.appendChild(node('span', 'sh_js_method', p7));
			}
			offset = pos + subStr.length;
      	});
      	$f.appendChild(document.createTextNode(source.substring(offset)));

      	return $f;
	},
};






var jsEdit = new HtmlEdit(
	$4.id('js-form'), 
	new SHighlighter(HighlighterSets.js), 
	{
		// splitOnLines: true,
	}
);
var original = [
'aaaa "usestrict";\nvar d = 12;',
'var _helpers = {',
'\thtmlspecialchars: function(str){',
'\t\treturn str.replace(/&/g, \'&amp;\').replace(/</g, \'&lt;\').replace(/>/g, \'&gt;\');',
'\t},',
'};',
'var str1= `abc\n123`;',
'\n// comment',
'code;',
'/* \n\tcomment \n\t comment2 \n*/',
'\'/[^/]*$/fg\'.match(d)',
'/ww/ig + /www/ig',
'var json = {\n\ttest: true,\n\t\"copyright\": \"\u00a9 Doctor Web\\n    2003 \u2014 2017\",\n}',
'"привет мир";',
].join('\n');

/*
"copyright": "\u00a9 Doctor Web\n    2003 \u2014 2017",

*/



console.time('innerHtml method');
jsEdit.setText(original);
console.timeEnd('innerHtml method');

var highlightEngine = new JsHighlight2();

console.time('frag method');
$4.id('js-form-alt').appendChild(highlightEngine.prettify(original))
console.timeEnd('frag method');


var JSHighlight = {
	htmlspecialchars: function(str){
		return str ? str.replace(/[<>&]/g, function(m){
			return m == '<' ? '&lt;' : m == '>' ? '&gt;' : '&amp;'
		}) : '';
	},
	PRETTIFY: new RegExp(
		"(//.*(?=[\\n]|$))|" + // single line comment
		'(\\/\\*[\\s\\S]*?($|\\*\\/))|' + // multiline comment
		'((?:\"[^\"\\\\]*(?:\\\\.[^\"\\\\]*)*\")|(?:\'[^\'\\\\]*(?:\\\\.[^\'\\\\]*)*\'))|' + // single or double quote strings
		'(`[\\s\\S]+?`)|' + // multiline js strings
		'(' + // regular expression literal 
			'(?:\\/[^\\s]+(?!\\\\)\\/)[img]{0,3}(?!\\d)(?=\\s*[\\;,\\x5d\\x29\\x2e\\n]?)' +
		')|' +		
		"(\\b(?:break|continue|do|else|for|if|return|while|var|function|new)\\b)|" + // keywords
		"(\\b(?:(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?)|(?:undefined|null)\\b)|" + // numbers
		"(?:[.]([\\w]+)(?=[(]))", // methods
	'g'),
	prettify: function(str){
		// Escape unicode characters
		str = str.replace(/([\u0080-\u0400\u04FF-\uFFFF])/g, function(s){
			var 	c = s.charCodeAt(0).toString(16), 
					i = 4 - c.length; 

			while(i-- > 0) c = '0' + c; 
			return '\\u' + c;
		});

		var out = this.htmlspecialchars(str).replace(this.PRETTIFY, function(subStr, p1, p2, p2end, str1, str2, reg, p5, p6, p7){
			if(p1 != undefined){
				return '<span class="sh_js_comment">' + subStr + '</span>';
			}else if(p2 != undefined){
				return '<span class="sh_js_comment sh_multiline">' + subStr.replace(/\n/g, '</span>\n<span class="sh_js_comment sh_multiline">') + '</span>';
			}else if(str1 != undefined || reg != undefined){
				return '<span class="sh_js_string">' + subStr + '</span>';
			}else if(str2 != undefined){
				return '<span class="sh_js_string sh_multiline">' + subStr.replace(/\n/g, '</span>\n<span class="sh_js_string sh_multiline">') + '</span>';
			}else if(p5 != undefined){
				return '<span class="sh_js_keyword">' + subStr + '</span>';
			}else if(p6 != undefined){
				return '<span class="sh_js_number">' + subStr + '</span>';
			}else if(p7 != undefined){
				return '.<span class="sh_js_method">' + p7 + '</span>';
			}
      	});

      	return out;	
	},
}

console.time('str singleton method');
$4.id('js-form-str').innerHTML = JSHighlight.prettify(original);
console.timeEnd('str singleton method');

</script>
</body>
</html>
